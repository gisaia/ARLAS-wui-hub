@if (isLoading) {
<div class="collection--loading">
    <mat-spinner></mat-spinner>
</div>
}
<form [formGroup]="collectionForm" autocomplete="off">
    <div class="collection">
        <div class="collection__top">
            <div class="collection__top__content">
                <button class="collection__top__content__btn" mat-stroked-button (click)="back()">Â« {{'Collections' |
                    translate}}</button>
                <div class="collection__top__content__title">
                    <span class="collection__top__content__title__display-name">
                        <mat-form-field class="small with-label" floatLabel="never" [subscriptSizing]="'dynamic'">
                            <mat-label>{{'Name' | translate}}</mat-label>
                            <input matInput class="input-display-name" formControlName="collection_display_name">
                        </mat-form-field>
                    </span>
                    <span class="collection__top__content__title__name">({{collection?.collection_name}})</span>
                </div>
                <button class="collection__top__content__update" [class.spinner]="isLoading"
                    [disabled]="isLoading || (!this.collectionForm.dirty && !this.collectionForm.touched)"
                    mat-flat-button color="primary" (click)="update()">{{'Update' | translate}}</button>
            </div>
        </div>

        <div class="collection__info">
            <div class="collection__info__visibility">
                <div class="collection__info__visibility__title">
                    {{'Visibility' | translate}}
                </div>
                <div class="collection__info__visibility__items">
                    <div class="collection__info__visibility__items__item">
                        <span class="prop">{{'Owner' | translate}}</span>
                        <span class="value">{{collection?.params?.organisations.owner}}</span>
                    </div>
                    @if(organisations().length > 1){
                    <div class="collection__info__visibility__items__item">
                        <span class="prop">{{'Shared with' | translate}}</span>
                        <span class="value">
                            <mat-form-field class="small" [subscriptSizing]="'dynamic'">
                                <mat-select formControlName="shared_orgs" multiple>
                                    @for (org of organisations(); track $index) {
                                    <mat-option [value]="org.name">{{org.name}}</mat-option>
                                    }
                                </mat-select>
                            </mat-form-field>
                        </span>
                    </div>
                    }
                    <div class="collection__info__visibility__items__item">
                        <span class="prop">{{'Visibility' | translate}}</span>
                        <span class="value">
                            <mat-chip-set>
                                @if (collection?.params?.organisations.public) {
                                <mat-chip class="visibility-chip">{{'Public' | translate}}</mat-chip>
                                } @else {
                                <mat-chip class="visibility-chip">{{'Private' | translate}}</mat-chip>
                                }
                            </mat-chip-set>
                        </span>
                    </div>
                </div>
            </div>
            <div class="collection__info__params">
                <div class="collection__info__params__title">
                    {{'Parameters' | translate}}
                </div>
                <div class="collection__info__params__items">
                    <div class="collection__info__params__items__item">
                        <span class="prop">{{'id' | translate}}</span>
                        <span class="value">{{collection?.params?.id_path}}</span>
                    </div>
                    <div class="collection__info__params__items__item">
                        <span class="prop">{{'Centroid' | translate}}</span>
                        <span class="value">{{collection?.params?.centroid_path}}</span>
                    </div>
                    <div class="collection__info__params__items__item">
                        <span class="prop">{{'Geometry' | translate}}</span>
                        <span class="value">{{collection?.params?.geometry_path}}</span>
                    </div>
                    <div class="collection__info__params__items__item">
                        <span class="prop">{{'Timestamp' | translate}}</span>
                        <span class="value">{{collection?.params?.timestamp_path}}</span>
                    </div>
                    <div class="collection__info__params__items__item">
                        <span class="prop">{{'Index name' | translate}}</span>
                        <span class="value">{{collection?.params?.index_name}}</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="collection__fields">


            <div class="collection__fields__title">
                {{'Fields' | translate}}
                <div>
                    <mat-form-field class="small filter" floatLabel="never" [subscriptSizing]="'dynamic'">
                        <input (keyup)="applyFilter($event)" matInput class="input-display-name"
                            [placeholder]="'Filter fields (on identifier, name, type)' | translate">
                    </mat-form-field>
                </div>
            </div>
            <div class="collection__fields__table">

                <ng-container formArrayName="display_names">
                    <table #fieldTableSort="matSort" mat-table [dataSource]="dataSourceFields" matSort>
                        <ng-container matColumnDef="name">
                            <th mat-header-cell *matHeaderCellDef mat-sort-header> {{'Identifier' | translate}} </th>
                            <td mat-cell *matCellDef="let row">
                                {{row.name}}
                            </td>
                        </ng-container>

                        <ng-container matColumnDef="display_name">
                            <th mat-header-cell *matHeaderCellDef mat-sort-header> {{'Name' | translate}} </th>
                            <td mat-cell *matCellDef="let row">
                                <mat-form-field class="small" floatLabel="never" [subscriptSizing]="'dynamic'">
                                    <input matInput class="input-display-name" placeholder="..."
                                        [formControl]="row.control">
                                </mat-form-field>
                            </td>
                        </ng-container>

                        <ng-container matColumnDef="type">
                            <th mat-header-cell *matHeaderCellDef mat-sort-header> {{'Type' | translate}} </th>
                            <td mat-cell *matCellDef="let row">
                                {{row.type | field_type_to_text}}
                            </td>
                        </ng-container>

                        <ng-container matColumnDef="taggable">
                            <th mat-header-cell *matHeaderCellDef mat-sort-header> {{'Taggable' | translate}} </th>
                            <td mat-cell *matCellDef="let row">
                                {{row.taggable | boolean_to_text}}
                            </td>
                        </ng-container>

                        <ng-container matColumnDef="indexed">
                            <th mat-header-cell *matHeaderCellDef mat-sort-header> {{'Indexed' | translate}} </th>
                            <td mat-cell *matCellDef="let row">
                                {{row.indexed | boolean_to_text}}
                            </td>
                        </ng-container>

                        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                        <tr mat-row *matRowDef="let row; let odd = odd; columns: displayedColumns;"
                            [class.striped-row]="odd"></tr>

                        <tr class="mat-row" *matNoDataRow>
                            <td class="mat-cell" colspan="5">
                                @if (!isLoading) {
                                <div class="no-data">{{'No fields matching the filter' | translate}}</div>
                                }
                            </td>
                        </tr>
                    </table>
                </ng-container>

            </div>
        </div>
    </div>
</form>
